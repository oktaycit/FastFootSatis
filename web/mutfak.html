<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutfak EkranÄ± - FastFootSatÄ±s</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            background: #1a1a1a;
            color: white;
            overflow: auto;
        }

        .kitchen-grid {
            padding: 20px;
        }
    </style>
</head>

<body>
    <div class="kitchen-container">
        <header class="kitchen-header">
            <h1>ğŸ‘¨â€ğŸ³ MUTFAK SÄ°PARÄ°Å TAKÄ°P</h1>
            <div class="auto-print-switch">
                <label>Otomatik YazdÄ±r</label>
                <input type="checkbox" id="autoPrintToggle">
            </div>
            <div id="clock" style="font-size: 24px; font-weight: bold;">00:00:00</div>
        </header>
        <div class="kitchen-grid" id="kitchenGrid">
            <!-- SipariÅŸ kartlarÄ± buraya gelecek -->
        </div>
    </div>

    <!-- YazdÄ±rma AlanÄ± (Gizli) -->
    <div id="printArea" class="print-area" style="display: none;"></div>

    <script>
        const socket = io();
        const kitchenGrid = document.getElementById('kitchenGrid');
        const autoPrintToggle = document.getElementById('autoPrintToggle');
        const orders = [];

        // Saat gÃ¼ncelleme
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString('tr-TR');
        }, 1000);

        socket.on('kitchen_new_order', (data) => {
            console.log('New order received:', data);
            addOrderToGrid(data);
            if (autoPrintToggle.checked) {
                printOrder(data);
            }
            playNotificationSound();
        });

        socket.on('kitchen_cancel_order', (data) => {
            console.log('Order cancelled:', data);
            const card = document.querySelector(`.order-card[data-masa="${data.masa}"]`);
            if (card) {
                const itemElem = card.querySelector(`.order-card-item[data-uid="${data.uid}"]`);
                if (itemElem) {
                    itemElem.style.textDecoration = 'line-through';
                    itemElem.style.opacity = '0.5';
                    setTimeout(() => {
                        itemElem.remove();
                        // EÄŸer kartta Ã¼rÃ¼n kalmadÄ±ysa kartÄ± sil
                        if (card.querySelectorAll('.order-card-item').length === 0) {
                            card.remove();
                        }
                    }, 1000);
                }
            }
        });

        socket.on('initial_data', (data) => {
            console.log('Initial data received:', data);
            kitchenGrid.innerHTML = ''; // Temizle
            const adisyonlar = data.adisyonlar || {};

            for (const masa in adisyonlar) {
                const items = adisyonlar[masa];
                if (items && items.length > 0) {
                    // Masadaki her Ã¼rÃ¼n iÃ§in karta ekle
                    items.forEach(item => {
                        if (item.durum !== 'hazir') { // Sadece hazÄ±r olmayanlarÄ± gÃ¶ster
                            addOrderToGrid({
                                uid: item.uid,
                                masa: masa,
                                urun: item.urun,
                                adet: item.adet,
                                garson: item.garson,
                                saat: item.saat || '--:--:--'
                            }, false);
                        }
                    });
                }
            }
        });

        function addOrderToGrid(data, showNewEffect = true) {
            // Mevcut kartÄ± ara (masa bazlÄ±)
            let card = document.querySelector(`.order-card[data-masa="${data.masa}"]`);

            if (card) {
                // Kart bulundu, iÃ§ine yeni Ã¼rÃ¼nÃ¼ ekle
                const itemsContainer = card.querySelector('.order-card-items');
                const newItem = document.createElement('div');
                newItem.className = 'order-card-item';
                newItem.dataset.uid = data.uid;
                newItem.textContent = `${data.adet}x ${data.urun}${data.not ? ' (' + data.not + ')' : ''} (${data.garson || '?'})`;
                itemsContainer.appendChild(newItem);

                // GarsonlarÄ± gÃ¼ncelle
                if (data.garson) {
                    let waiters = JSON.parse(card.dataset.waiters || '[]');
                    if (!waiters.includes(data.garson)) {
                        waiters.push(data.garson);
                        card.dataset.waiters = JSON.stringify(waiters);
                    }
                }

                // ZamanÄ± gÃ¼ncelle
                card.querySelector('.order-card-time').textContent = data.saat;

                if (showNewEffect) {
                    card.classList.add('new');
                    setTimeout(() => card.classList.remove('new'), 5000);
                }
            } else {
                // Kart bulunamadÄ±, yeni kart oluÅŸtur
                card = document.createElement('div');
                card.className = showNewEffect ? 'order-card new' : 'order-card';
                card.dataset.masa = data.masa;
                const initialWaiters = data.garson ? [data.garson] : [];
                card.dataset.waiters = JSON.stringify(initialWaiters);

                const cardId = `order-${data.masa.replace(/\s+/g, '-')}`;
                card.id = cardId;

                card.innerHTML = `
                    <div class="order-card-header">
                        <span class="order-card-masa">${data.masa}</span>
                        <span class="order-card-time">${data.saat}</span>
                    </div>
                    <div class="order-card-items">
                        <div class="order-card-item" data-uid="${data.uid}">${data.adet}x ${data.urun}${data.not ? ' (' + data.not + ')' : ''} (${data.garson || '?'})</div>
                    </div>
                    <div class="order-card-actions">
                        <button class="btn btn-kitchen-done" onclick="completeOrder('${cardId}')">TAMAMLANDI</button>
                    </div>
                `;

                kitchenGrid.prepend(card);
                if (showNewEffect) {
                    setTimeout(() => card.classList.remove('new'), 5000);
                }
            }
        }

        function completeOrder(id) {
            const card = document.getElementById(id);
            if (card) {
                const masa = card.dataset.masa;
                const waiters = JSON.parse(card.dataset.waiters || '[]');
                const itemsUids = Array.from(card.querySelectorAll('.order-card-item')).map(el => el.dataset.uid);

                // Sunucuya bildir
                socket.emit('kitchen_order_ready', {
                    masa: masa,
                    waiters: waiters,
                    items_uids: itemsUids
                });

                card.style.transform = 'scale(0.8)';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 300);
            }
        }

        function printOrder(data) {
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = `
                <div style="text-align: center; font-family: 'Courier New', monospace; width: 80mm; padding: 10px; color: black; background: white;">
                    <h2 style="margin: 0;">MUTFAK FÄ°ÅÄ°</h2>
                    <hr>
                    <h1 style="margin: 10px 0;">${data.masa}</h1>
                    <div style="text-align: left; font-size: 20px; font-weight: bold;">
                        ${data.adet} x ${data.urun}${data.not ? '<br><small>(' + data.not + ')</small>' : ''}
                    </div>
                    <hr>
                    <div style="font-size: 12px;">${data.saat}</div>
                </div>
            `;
            window.print();
        }

        function playNotificationSound() {
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(e => console.log('Audio play failed:', e));
        }
    </script>
</body>

</html>