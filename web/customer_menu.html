<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastFoot QR MenÃ¼</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Fraunces:opsz,wght@9..144,500;9..144,700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f4f1ea;
            --panel: #fffdf8;
            --ink: #1f2024;
            --muted: #6d7079;
            --line: #dfd8ca;
            --brand: #0f8b6d;
            --brand-dark: #0a5a47;
            --accent: #f6a700;
            --danger: #be1e2d;
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            color: var(--ink);
            font-family: Manrope, "Avenir Next", "Trebuchet MS", sans-serif;
            background:
                radial-gradient(1200px 400px at 10% -20%, #ffe5b4 0%, transparent 60%),
                radial-gradient(900px 360px at 100% 0%, #d1f7ef 0%, transparent 55%),
                var(--bg);
        }

        .wrap {
            max-width: 1080px;
            margin: 0 auto;
            padding: 16px;
        }

        .hero {
            background: linear-gradient(135deg, #1c2a2b 0%, #2f473f 100%);
            color: #f3f6f8;
            padding: 18px;
            border-radius: 18px;
            box-shadow: 0 16px 28px rgba(0, 0, 0, 0.18);
            position: sticky;
            top: 10px;
            z-index: 10;
        }

        .hero h1 {
            margin: 0;
            font-family: Fraunces, Georgia, serif;
            font-weight: 700;
            letter-spacing: 0.3px;
            font-size: 22px;
        }

        .hero-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .badge {
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.07);
        }

        .badge.online-badge {
            background: rgba(246, 167, 0, 0.25);
            border-color: rgba(246, 167, 0, 0.5);
        }

        .layout {
            margin-top: 14px;
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 14px;
            align-items: start;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.06);
        }

        .menu-pane {
            padding: 12px;
        }

        .cat-tabs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 8px;
            margin-bottom: 8px;
            scrollbar-width: none;
        }

        .cat-tabs::-webkit-scrollbar {
            display: none;
        }

        .tab {
            border: 1px solid var(--line);
            background: #fff;
            color: var(--ink);
            border-radius: 999px;
            padding: 7px 12px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            font-size: 13px;
        }

        .tab.active {
            background: var(--ink);
            color: #fff;
            border-color: var(--ink);
        }

        .items {
            display: grid;
            gap: 8px;
        }

        .item {
            grid-template-columns: 64px 1fr auto;
            display: grid;
            gap: 10px;
            align-items: center;
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px;
            background: #fff;
        }

        .item h3 {
            margin: 0 0 4px;
            font-size: 16px;
        }

        .price {
            color: var(--brand-dark);
            font-weight: 800;
            font-size: 14px;
        }

        .btn {
            border: none;
            border-radius: 10px;
            padding: 9px 12px;
            font-weight: 800;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-main {
            background: var(--brand);
            color: #fff;
        }

        .btn-main:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        .btn-soft {
            background: #eff3f8;
            color: #1f2937;
        }

        .cart-pane {
            padding: 12px;
            position: sticky;
            top: 165px;
        }

        .cart-list {
            max-height: 280px;
            overflow: auto;
            display: grid;
            gap: 7px;
            margin-bottom: 8px;
        }

        .cart-row {
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
            font-size: 14px;
            background: #fff;
        }

        .section-title {
            margin: 0 0 8px;
            font-size: 13px;
            letter-spacing: .8px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .total {
            font-size: 24px;
            font-weight: 800;
            margin: 4px 0 10px;
            font-family: Fraunces, Georgia, serif;
        }

        /* ---- Masa doÄŸrulama paneli ---- */
        .verify {
            border: 1px dashed var(--line);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fbfaf7;
        }

        .verify-row {
            display: flex;
            gap: 8px;
            margin-top: 7px;
        }

        /* ---- Online sipariÅŸ formu ---- */
        .online-form {
            border: 1px solid #f6a700;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            background: #fffbf0;
        }

        .online-form-title {
            font-size: 14px;
            font-weight: 800;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .online-form label {
            font-size: 12px;
            font-weight: 700;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
            margin-top: 8px;
        }

        .online-form label:first-of-type {
            margin-top: 0;
        }

        /* Ã–deme tipi seÃ§ici */
        .pay-choice {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
        }

        .pay-btn {
            padding: 9px 6px;
            border: 2px solid var(--line);
            border-radius: 10px;
            background: #fff;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: border-color 0.15s, background 0.15s;
        }

        .pay-btn.selected-nakit {
            border-color: var(--brand);
            background: #e8f8f4;
            color: var(--brand-dark);
        }

        .pay-btn.selected-kart {
            border-color: #4f6ef7;
            background: #eef1ff;
            color: #2c3dd1;
        }

        input,
        textarea,
        select {
            width: 100%;
            border: 1px solid var(--line);
            border-radius: 9px;
            padding: 9px 10px;
            font-family: inherit;
            font-size: 14px;
            background: #fff;
        }

        textarea {
            resize: vertical;
            min-height: 56px;
        }

        .status {
            min-height: 20px;
            font-size: 13px;
            color: #8a3c00;
            font-weight: 700;
            margin-top: 5px;
        }

        .ok {
            color: #116149;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            line-height: 1.4;
        }

        .featured {
            margin-bottom: 10px;
            border: 1px solid #2f4a42;
            border-radius: 12px;
            padding: 10px;
            background: linear-gradient(115deg, rgba(246, 167, 0, 0.2), rgba(15, 139, 109, 0.16));
        }

        .featured h2 {
            margin: 0;
            font-size: 16px;
        }

        .featured p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #2f3f3b;
        }

        .tools-row {
            display: grid;
            grid-template-columns: 1fr 180px;
            gap: 8px;
            margin-bottom: 10px;
        }

        .reco-row {
            margin-bottom: 10px;
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .reco-row::-webkit-scrollbar {
            display: none;
        }

        .reco-chip {
            border: 1px solid #d5c8af;
            background: #fff6df;
            color: #6f4f00;
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 800;
            white-space: nowrap;
            cursor: pointer;
        }

        .item-media {
            width: 64px;
            height: 64px;
            border-radius: 10px;
            border: 1px solid var(--line);
            overflow: hidden;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5b2d00;
            font-weight: 800;
        }

        .item-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* BaÅŸarÄ± ekranÄ± */
        .success-screen {
            display: none;
            text-align: center;
            padding: 32px 16px;
        }

        .success-icon {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .success-title {
            font-size: 22px;
            font-weight: 800;
            font-family: Fraunces, Georgia, serif;
            margin-bottom: 8px;
        }

        .success-sub {
            color: var(--muted);
            font-size: 14px;
        }

        @media (max-width: 930px) {
            .layout {
                grid-template-columns: 1fr;
            }

            .cart-pane {
                position: static;
            }

            .hero {
                position: static;
            }

            .tools-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="hero">
            <h1 id="heroTitle">FastFoot QR MenÃ¼</h1>
            <div class="hero-meta">
                <span class="badge" id="tableInfo">MenÃ¼</span>
                <span class="badge" id="modeBadge">CanlÄ± MenÃ¼</span>
                <span class="badge">HÄ±zlÄ± SipariÅŸ</span>
            </div>
            <div class="status" id="verifyStatus">YÃ¼kleniyor...</div>
        </header>

        <main class="layout">
            <section class="card menu-pane">
                <div class="featured">
                    <h2>BugÃ¼nÃ¼n SeÃ§imi</h2>
                    <p>Ã–ne Ã§Ä±kan Ã¼rÃ¼nleri tek dokunuÅŸla sepete ekleyin.</p>
                </div>
                <div class="tools-row">
                    <input id="searchInput" placeholder="ÃœrÃ¼n ara..." />
                    <select id="sortSelect">
                        <option value="recommended">Ã–nerilenler</option>
                        <option value="price_asc">Fiyat Artan</option>
                        <option value="price_desc">Fiyat Azalan</option>
                        <option value="name_asc">Ä°sim A-Z</option>
                    </select>
                </div>
                <div id="recoRow" class="reco-row"></div>
                <div class="cat-tabs" id="catTabs"></div>
                <div id="menuRoot" class="items"></div>
            </section>

            <aside class="card cart-pane">
                <h3 class="section-title">Sepet</h3>
                <div id="cartRoot" class="cart-list"></div>
                <div id="cartTotal" class="total">0.00 TL</div>

                <!-- BaÅŸarÄ± ekranÄ± -->
                <div class="success-screen" id="successScreen">
                    <div class="success-icon">âœ…</div>
                    <div class="success-title">SipariÅŸiniz AlÄ±ndÄ±!</div>
                    <p class="success-sub" id="successSub">En kÄ±sa sÃ¼rede sizi arayacaÄŸÄ±z.</p>
                    <br>
                    <button class="btn btn-soft" style="width:100%;" onclick="resetAfterOrder()">Yeni SipariÅŸ
                        Ver</button>
                </div>

                <!-- MASA MODU: QR / NFC doÄŸrulama paneli -->
                <div class="verify" id="tableModePanel">
                    <strong style="font-size:14px;">Masa DoÄŸrulama</strong>
                    <div class="hint">Dinamik QR veya NFC ile doÄŸrulayÄ±n.</div>
                    <div class="verify-row" id="qrRow">
                        <input id="qrTokenInput" placeholder="Dinamik QR token" />
                        <button class="btn btn-soft" id="btnVerify">QR</button>
                    </div>
                    <div class="verify-row" id="nfcRow">
                        <input id="nfcUidInput" placeholder="NFC UID" />
                        <button class="btn btn-soft" id="btnVerifyNfc">NFC</button>
                    </div>
                    <div class="verify-row" id="nfcReadRow">
                        <button class="btn btn-soft" style="width:100%;" id="btnReadNfc">Telefondan NFC Oku</button>
                    </div>
                </div>

                <!-- ONLÄ°NE MODU: MÃ¼ÅŸteri bilgi formu -->
                <div class="online-form" id="onlineModePanel" style="display:none;">
                    <div class="online-form-title">ðŸ“¦ Teslimat Bilgileri</div>
                    <label>Ad Soyad *</label>
                    <input id="onlineAd" placeholder="Ali Veli" autocomplete="name" />
                    <label>Telefon *</label>
                    <input id="onlineTel" placeholder="0532 000 00 00" type="tel" autocomplete="tel" inputmode="tel" />
                    <label>Teslimat Adresi *</label>
                    <textarea id="onlineAdres" placeholder="Mahalle, sokak, no, kat, daire..."></textarea>
                    <label>Not (opsiyonel)</label>
                    <input id="onlineNot" placeholder="KapÄ±yÄ± Ã§almayÄ±n, zil Ã§alÄ±n vb." />
                    <label>Ã–deme YÃ¶ntemi</label>
                    <div class="pay-choice">
                        <button class="pay-btn selected-nakit" id="payNakit" onclick="selectOdeme('nakit')">ðŸ’µ KapÄ±da
                            Nakit</button>
                        <button class="pay-btn" id="payKart" onclick="selectOdeme('kart')">ðŸ’³ KapÄ±da Kart (POS)</button>
                    </div>
                </div>

                <button class="btn btn-main" style="width:100%;margin-top:4px;" id="btnOrder">SipariÅŸi GÃ¶nder</button>
                <p class="hint" id="orderHint">DoÄŸrulama sonrasÄ± sipariÅŸiniz doÄŸrudan mutfaÄŸa dÃ¼ÅŸer.</p>
            </aside>
        </main>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const tableHint = (params.get('table_hint') || '').trim();
        const tokenFromUrl = (params.get('qr_token') || '').trim();
        const isOnlineMode = (params.get('mode') || '').trim().toLowerCase() === 'online';

        const state = {
            menu: {},
            categories: [],
            activeCategory: null,
            searchQuery: '',
            sortMode: 'recommended',
            cart: {},
            sessionToken: localStorage.getItem('public_session_token') || '',
            tableName: tableHint,
            verified: false,
            orderPrefs: JSON.parse(localStorage.getItem('menu_order_prefs') || '{}'),
            odeme_tipi: 'nakit',
            policy: {
                verify_mode: 'hybrid',
                verify_required: true,
                allow_dynamic_qr: true,
                allow_nfc: true
            }
        };

        // --- DOM refs ---
        const heroTitle = document.getElementById('heroTitle');
        const tableInfo = document.getElementById('tableInfo');
        const modeBadge = document.getElementById('modeBadge');
        const verifyStatus = document.getElementById('verifyStatus');
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');
        const recoRow = document.getElementById('recoRow');
        const catTabs = document.getElementById('catTabs');
        const menuRoot = document.getElementById('menuRoot');
        const cartRoot = document.getElementById('cartRoot');
        const cartTotal = document.getElementById('cartTotal');
        const tableModePanel = document.getElementById('tableModePanel');
        const onlineModePanel = document.getElementById('onlineModePanel');
        const qrTokenInput = document.getElementById('qrTokenInput');
        const nfcUidInput = document.getElementById('nfcUidInput');
        const btnVerify = document.getElementById('btnVerify');
        const btnVerifyNfc = document.getElementById('btnVerifyNfc');
        const btnReadNfc = document.getElementById('btnReadNfc');
        const btnOrder = document.getElementById('btnOrder');
        const orderHint = document.getElementById('orderHint');
        const successScreen = document.getElementById('successScreen');

        // --- Mod BaÅŸlatma ---
        function initMode() {
            if (isOnlineMode) {
                heroTitle.textContent = 'FastFoot Online SipariÅŸ';
                modeBadge.textContent = 'Online SipariÅŸ';
                modeBadge.classList.add('online-badge');
                tableInfo.textContent = 'Teslimat';
                tableModePanel.style.display = 'none';
                onlineModePanel.style.display = 'block';
                orderHint.textContent = 'Bilgilerinizi doldurup sipariÅŸi gÃ¶nderin, sizi arayacaÄŸÄ±z.';
                setStatus('Online sipariÅŸ modu â€” bilgilerinizi girin', true);
            } else {
                if (tableHint) tableInfo.textContent = `Masa: ${tableHint}`;
                if (tokenFromUrl) qrTokenInput.value = tokenFromUrl;
            }
        }

        // Ã–deme tipi seÃ§ici
        window.selectOdeme = function (tip) {
            state.odeme_tipi = tip;
            document.getElementById('payNakit').className = 'pay-btn' + (tip === 'nakit' ? ' selected-nakit' : '');
            document.getElementById('payKart').className = 'pay-btn' + (tip === 'kart' ? ' selected-kart' : '');
        };

        function fingerprint() {
            const raw = [navigator.userAgent, navigator.language, screen.width, screen.height, Intl.DateTimeFormat().resolvedOptions().timeZone].join('|');
            return btoa(unescape(encodeURIComponent(raw))).slice(0, 180);
        }

        function setStatus(msg, ok = false) {
            verifyStatus.textContent = msg;
            verifyStatus.classList.toggle('ok', !!ok);
        }

        function escapeHtml(text) {
            return String(text)
                .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        function escapeJs(text) {
            return String(text).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        }
        function getItemName(item) { return String(item[0] || '').trim(); }
        function getItemPrice(item) { return Number(item[1] || 0); }
        function getItemImageUrl(item) {
            const candidate = item[6] || item[7];
            if (typeof candidate === 'string' && candidate.trim()) {
                const c = candidate.trim();
                if (c.startsWith('http://') || c.startsWith('https://') || c.startsWith('/')) return c;
            }
            return null;
        }
        function getRecommendedScore(item) {
            const name = getItemName(item), price = getItemPrice(item);
            const pref = Number(state.orderPrefs[name] || 0);
            const platformBoost = Number(item[2] || 0) + Number(item[3] || 0) + Number(item[4] || 0) + Number(item[5] || 0);
            const priceBoost = price > 0 ? Math.max(0, 120 / price) : 0;
            return pref * 5 + platformBoost + priceBoost;
        }
        function getVisibleItemsForCategory(cat) {
            const items = (state.menu[cat] || []).slice();
            const q = state.searchQuery.toLowerCase();
            let visible = q ? items.filter(it => getItemName(it).toLowerCase().includes(q)) : items;
            if (state.sortMode === 'price_asc') visible.sort((a, b) => getItemPrice(a) - getItemPrice(b));
            else if (state.sortMode === 'price_desc') visible.sort((a, b) => getItemPrice(b) - getItemPrice(a));
            else if (state.sortMode === 'name_asc') visible.sort((a, b) => getItemName(a).localeCompare(getItemName(b), 'tr'));
            else visible.sort((a, b) => getRecommendedScore(b) - getRecommendedScore(a));
            return visible;
        }

        async function loadMenu() {
            const r = await fetch(`/api/public/menu?table_hint=${encodeURIComponent(tableHint)}`);
            const data = await r.json();
            state.menu = data.menu || {};
            state.categories = Object.keys(state.menu);
            state.activeCategory = state.categories[0] || null;
            renderCategoryTabs(); renderRecommendations(); renderMenu();
            if (!isOnlineMode) setStatus(tableHint ? `Masa: ${tableHint}` : 'MenÃ¼ye hoÅŸ geldiniz', true);
        }

        async function loadPolicy() {
            if (isOnlineMode) return; // Online modda QR/NFC politikasÄ± gerekmez
            try {
                const r = await fetch('/api/public/policy');
                const data = await r.json();
                if (data && data.success) {
                    state.policy = {
                        verify_mode: data.verify_mode || 'hybrid',
                        verify_required: !!data.verify_required,
                        allow_dynamic_qr: !!data.allow_dynamic_qr,
                        allow_nfc: !!data.allow_nfc
                    };
                }
            } catch (e) { }
            applyPolicyToUi();
        }

        function applyPolicyToUi() {
            const qrRow = document.getElementById('qrRow');
            const nfcRow = document.getElementById('nfcRow');
            const nfcReadRow = document.getElementById('nfcReadRow');
            if (qrRow) qrRow.style.display = state.policy.allow_dynamic_qr ? 'flex' : 'none';
            if (nfcRow) nfcRow.style.display = state.policy.allow_nfc ? 'flex' : 'none';
            if (nfcReadRow) nfcReadRow.style.display = state.policy.allow_nfc ? 'flex' : 'none';
            if (!state.policy.verify_required) setStatus('DoÄŸrulama gerekmiyor', true);
            else setStatus('DoÄŸrulama bekleniyor');
        }

        function renderCategoryTabs() {
            if (!state.categories.length) { catTabs.innerHTML = ''; return; }
            catTabs.innerHTML = state.categories.map(cat => {
                const active = cat === state.activeCategory ? 'active' : '';
                return `<button class="tab ${active}" onclick="selectCategory('${escapeJs(cat)}')">${escapeHtml(cat)}</button>`;
            }).join('');
        }
        window.selectCategory = (cat) => {
            state.activeCategory = cat;
            renderCategoryTabs(); renderRecommendations(); renderMenu();
        };
        function renderRecommendations() {
            const allItems = Object.values(state.menu).flat();
            if (!allItems.length) { recoRow.innerHTML = ''; return; }
            const top = allItems.slice().sort((a, b) => getRecommendedScore(b) - getRecommendedScore(a)).slice(0, 8);
            recoRow.innerHTML = top.map(item => {
                const name = getItemName(item), price = getItemPrice(item);
                return `<button class="reco-chip" onclick="addToCart('${escapeJs(name)}', ${price})">â˜… ${escapeHtml(name)}</button>`;
            }).join('');
        }
        function renderMenu() {
            if (!state.activeCategory || !state.menu[state.activeCategory]) {
                menuRoot.innerHTML = '<p class="hint">MenÃ¼ bulunamadÄ±.</p>'; return;
            }
            const items = getVisibleItemsForCategory(state.activeCategory);
            if (!items.length) { menuRoot.innerHTML = '<p class="hint">Filtreye uygun Ã¼rÃ¼n bulunamadÄ±.</p>'; return; }
            menuRoot.innerHTML = items.map(item => {
                const name = getItemName(item), price = getItemPrice(item);
                const imageUrl = getItemImageUrl(item);
                const fallback = escapeHtml(name.slice(0, 2).toUpperCase() || 'ÃœR');
                return `
                    <article class="item">
                        <div class="item-media">
                            ${imageUrl ? `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(name)}" loading="lazy" onerror="this.parentNode.innerHTML='${fallback}'">` : fallback}
                        </div>
                        <div>
                            <h3>${escapeHtml(name)}</h3>
                            <div class="price">${price.toFixed(2)} TL</div>
                        </div>
                        <button class="btn btn-main" onclick="addToCart('${escapeJs(name)}', ${price})">Ekle</button>
                    </article>`;
            }).join('');
        }

        window.addToCart = (name, price) => {
            const key = `${name}__${price}`;
            if (!state.cart[key]) state.cart[key] = { urun: name, fiyat: price, adet: 0 };
            state.cart[key].adet += 1;
            renderCart();
        };
        window.removeFromCart = (key) => {
            if (!state.cart[key]) return;
            state.cart[key].adet -= 1;
            if (state.cart[key].adet <= 0) delete state.cart[key];
            renderCart();
        };
        function renderCart() {
            const entries = Object.entries(state.cart);
            if (!entries.length) {
                cartRoot.innerHTML = '<p class="hint">Sepetiniz boÅŸ.</p>';
                cartTotal.textContent = '0.00 TL'; return;
            }
            let total = 0;
            cartRoot.innerHTML = entries.map(([key, item]) => {
                const line = Number(item.fiyat) * Number(item.adet);
                total += line;
                return `
                    <div class="cart-row">
                        <div>${escapeHtml(item.urun)}</div>
                        <div>${item.adet} x ${Number(item.fiyat).toFixed(2)}</div>
                        <button class="btn btn-danger" onclick="removeFromCart('${escapeJs(key)}')">-</button>
                    </div>`;
            }).join('');
            cartTotal.textContent = `${total.toFixed(2)} TL`;
        }

        // ========== MASA MODU: QR / NFC doÄŸrulama ==========
        async function verifyDynamicQr() {
            const qrToken = qrTokenInput.value.trim();
            if (!qrToken) { setStatus('Dinamik token gerekli'); return false; }
            const r = await fetch('/api/public/session/verify-dynamic-qr', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ qr_token: qrToken, table_hint: tableHint, device_fingerprint: fingerprint() })
            });
            const data = await r.json();
            if (!data.success) { setStatus(data.error || 'QR doÄŸrulama baÅŸarÄ±sÄ±z'); return false; }
            state.sessionToken = data.session_token;
            state.tableName = data.table_name;
            state.verified = true;
            localStorage.setItem('public_session_token', state.sessionToken);
            tableInfo.textContent = `Masa: ${state.tableName}`;
            setStatus('QR ile doÄŸrulandÄ±', true); return true;
        }
        async function verifyNfc() {
            const nfcUid = nfcUidInput.value.trim();
            if (!nfcUid) { setStatus('NFC UID gerekli'); return false; }
            const r = await fetch('/api/public/session/verify-nfc', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_hint: tableHint, nfc_uid: nfcUid, device_fingerprint: fingerprint() })
            });
            const data = await r.json();
            if (!data.success) { setStatus(data.error || 'NFC doÄŸrulama baÅŸarÄ±sÄ±z'); return false; }
            state.sessionToken = data.session_token;
            state.tableName = data.table_name;
            state.verified = true;
            localStorage.setItem('public_session_token', state.sessionToken);
            tableInfo.textContent = `Masa: ${state.tableName}`;
            setStatus('NFC ile doÄŸrulandÄ±', true); return true;
        }
        async function readNfcFromDevice() {
            if (!('NDEFReader' in window)) { setStatus('Bu cihaz/tarayÄ±cÄ± Web NFC desteklemiyor'); return; }
            try {
                const ndef = new NDEFReader();
                await ndef.scan(); setStatus('NFC bekleniyor...');
                ndef.onreading = (event) => {
                    const serial = event.serialNumber || '';
                    if (serial) { nfcUidInput.value = serial; setStatus('NFC okundu', true); }
                    else { setStatus('NFC seri no okunamadÄ±'); }
                };
            } catch (e) { setStatus('NFC okuma baÅŸlatÄ±lamadÄ±'); }
        }

        // ========== MASA MODU: SipariÅŸ gÃ¶nder ==========
        async function placeTableOrder() {
            const items = Object.values(state.cart);
            if (!items.length) { setStatus('Sepet boÅŸ'); return; }
            if (state.policy.verify_required && !state.sessionToken) {
                let ok = false;
                if (state.policy.allow_dynamic_qr && qrTokenInput.value.trim()) ok = await verifyDynamicQr();
                else if (state.policy.allow_nfc && nfcUidInput.value.trim()) ok = await verifyNfc();
                else if (state.policy.allow_dynamic_qr) ok = await verifyDynamicQr();
                else if (state.policy.allow_nfc) ok = await verifyNfc();
                if (!ok) return;
            }
            btnOrder.disabled = true; btnOrder.textContent = 'GÃ¶nderiliyor...';
            try {
                const r = await fetch('/api/public/order', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_token: state.sessionToken, table_name: state.tableName || tableHint, items })
                });
                const data = await r.json();
                if (!data.success) { setStatus(data.error || 'SipariÅŸ baÅŸarÄ±sÄ±z'); return; }
                recordOrderPrefs(items);
                state.cart = {};
                renderRecommendations(); renderMenu(); renderCart();
                setStatus('SipariÅŸ mutfaÄŸa iletildi âœ“', true);
            } finally {
                btnOrder.disabled = false; btnOrder.textContent = 'SipariÅŸi GÃ¶nder';
            }
        }

        // ========== ONLÄ°NE MODU: SipariÅŸ gÃ¶nder ==========
        async function placeOnlineOrder() {
            const items = Object.values(state.cart);
            if (!items.length) { setStatus('Sepet boÅŸ'); return; }
            const musteri_adi = document.getElementById('onlineAd').value.trim();
            const telefon = document.getElementById('onlineTel').value.trim();
            const adres = document.getElementById('onlineAdres').value.trim();
            const not_bilgisi = document.getElementById('onlineNot').value.trim();
            if (!musteri_adi) { setStatus('Ad Soyad zorunlu'); return; }
            if (!telefon || telefon.replace(/\D/g, '').length < 10) { setStatus('GeÃ§erli telefon numarasÄ± girin'); return; }
            if (!adres) { setStatus('Teslimat adresi zorunlu'); return; }

            btnOrder.disabled = true; btnOrder.textContent = 'GÃ¶nderiliyor...';
            try {
                const r = await fetch('/api/online/order', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ musteri_adi, telefon, adres, not: not_bilgisi, odeme_tipi: state.odeme_tipi, items })
                });
                const data = await r.json();
                if (!data.success) { setStatus(data.error || 'SipariÅŸ gÃ¶nderilemedi'); return; }
                recordOrderPrefs(items);
                // BaÅŸarÄ± ekranÄ±
                const odemeMetni = state.odeme_tipi === 'kart' ? 'Kurye kapÄ±nÄ±za POS cihazÄ±yla gelecek.' : 'Kurye kapÄ±nÄ±za nakit iÃ§in gelecek.';
                document.getElementById('successSub').textContent = `SipariÅŸiniz alÄ±ndÄ±! ${odemeMetni} En kÄ±sa sÃ¼rede sizi arayacaÄŸÄ±z.`;
                document.getElementById('successScreen').style.display = 'block';
                onlineModePanel.style.display = 'none';
                cartRoot.style.display = 'none'; cartTotal.style.display = 'none';
                btnOrder.style.display = 'none'; orderHint.style.display = 'none';
                state.cart = {};
                renderRecommendations(); renderMenu();
            } finally {
                btnOrder.disabled = false; btnOrder.textContent = 'SipariÅŸi GÃ¶nder';
            }
        }

        function recordOrderPrefs(items) {
            for (const item of items) {
                const n = item.urun;
                state.orderPrefs[n] = Number(state.orderPrefs[n] || 0) + Number(item.adet || 1);
            }
            localStorage.setItem('menu_order_prefs', JSON.stringify(state.orderPrefs));
        }

        window.resetAfterOrder = function () {
            document.getElementById('successScreen').style.display = 'none';
            onlineModePanel.style.display = 'block';
            cartRoot.style.display = ''; cartTotal.style.display = '';
            btnOrder.style.display = ''; orderHint.style.display = '';
            renderCart();
        };

        btnVerify.addEventListener('click', verifyDynamicQr);
        btnVerifyNfc.addEventListener('click', verifyNfc);
        btnReadNfc.addEventListener('click', readNfcFromDevice);
        searchInput.addEventListener('input', (e) => { state.searchQuery = (e.target.value || '').trim(); renderMenu(); });
        sortSelect.addEventListener('change', (e) => { state.sortMode = e.target.value || 'recommended'; renderMenu(); });
        btnOrder.addEventListener('click', () => isOnlineMode ? placeOnlineOrder() : placeTableOrder());

        // BaÅŸlat
        initMode();
        loadPolicy();
        loadMenu().catch(() => setStatus('MenÃ¼ yÃ¼klenemedi'));
        renderCart();
    </script>
</body>

</html>